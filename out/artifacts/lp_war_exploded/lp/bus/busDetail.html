#@busCommon()
#define css()
<style type="text/css">
    .bg{
        background:url(" lp/static/images/bus/bus_phone_bg.jpg") no-repeat center;
        background-size: 100% 100%;
        overflow-x: hidden;
        overflow-y: auto;
        width: 100%;
        height: auto;
        margin: 0 auto;
        padding-top: 1rem;
    }
    .navi{
        height:20% ;
        width: 100%;
        background-color: transparent;
        margin: 0 auto;
        border-bottom:0.03rem solid #DBDCDB;
    }
    .content{
        height: 80%;
        width: 100%;
        background-color: transparent;
        margin: 0 auto;
    }
    .item{
        height: auto;
        line-height: 1rem;
        font-size: 0.45rem;
    }
    .item label{
        color: #999999;
    }
    .item span{
        color: #444444;
        overflow: hidden;
        white-space:nowrap;
        text-overflow: ellipsis;
    }
    .item .tip-info{
        font-size:0.45rem;
        color: red;
        white-space: normal;
    }
    .icon-title{
        width: 8.5rem;
        height: auto;
        margin: 0.3rem auto;
        font-size: 0.4rem;
        text-align: justify;
    }
    .icon-title p {
        width: 2rem;
        height: 1rem;
        display: inline-block;
        text-align: center;
    }
    .icon-title p img{
        display: inline-block;
        height: 1rem;
    }
    .icon-title p span{
        display: block;
        width: auto;
        height: .8rem;
        line-height: .8rem;
    }
    .bus45{
        background:url(" lp/static/images/bus/bus_planform_bg_45.png") no-repeat center center;
        background-size: contain;
        width: 10rem;
        height: 16rem;
        margin: 0 auto;
    }
    .bus44{
        background:url(" lp/static/images/bus/bus_planform_bg_44.png") no-repeat center center;
        background-size: contain;
        width: 10rem;
        height: 16rem;
        margin: 0 auto;
    }
    .btn-container{
        width: 8.5rem;
        height: auto;
        margin: 0.15rem auto;
        font-size: .5rem;
    }
    .btn{
        display: inline-block;
        margin: 0.1rem auto;
        width: 100%;
        height: 1.3rem;
        border-radius: 0.13rem;
        border: 0.05rem solid #6B77F7;
        font-weight: bold;
    }
    .confirm{
        color: #FFFFFF;
        background-color: #6B77F7;
    }
    .cancel{
        color: #6B77F7;
        background-color: #FFFFFF;
    }
    .driveZone {
        width: 8.5rem;
        height: .8rem;
        margin: 0 auto;
    }
    .seatContainer{
        width: 8.5rem;
        height: 14.8rem;
        margin: 0 auto;
        font-size: .33rem;
    }
    .seat{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-gray.png") no-repeat center center;
        background-size: contain;
        text-align: center;
        vertical-align: bottom;
        color: #666666;
    }
    .seatHidden{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-gray.png") no-repeat center center;
        background-size: contain;
        text-align: center;
        visibility: hidden;
    }
    .seatChoose{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-blue.png") no-repeat center center;
        background-size: contain;
        text-align: center;
    }
    .seatSelected{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-cyan.png") no-repeat center center;
        background-size: contain;
        text-align: center;
    }
    .seatLocked{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-red.png") no-repeat center center;
        background-size: contain;
        text-align: center;
    }
    .seatNum{
        color: #6c6c6c;
    }
    .payBox {
        width: 100%;
        height: 100%;
    }
    .payBox .pay-info{
        height: 2rem;
        width: 100%;
    }
    .payBox .pay-info .icon{
        height: 35%;
        float: left;
    }
    .payBox .pay-info .reduce{
        margin: 8% 2% 0 5%;
    }
    .payBox .pay-info .add{
        margin: 8% 2% 0 2%;
    }
    .payBox .pay-info .people-num{
        height: 35%;
        width: 30%;
        border: .02rem solid #D4D4D4;
        margin: 8% 2% 0 2%;
        display: inline-block;
        font-size: .5rem;
    }
    .payBox .pay-info .seatList{
        width: 90%;
        height: 90%;
        margin: 0% 5%;
        float: left;
    }
    .payBox .pay-info button{
        width: 25%;
        height: 50%;
        float: left;
        margin: 8% 2%;
        font-size: .5rem;
        text-align: center;
        border:0.05rem solid #D4D4D4;
        background-color:#FFFFFF;
        color:#000;
        border-radius: .1rem;
    }
    .payBox .pay-info .choose-cancel{
        background: url(" lp/static/images/bus/ticket-cancel.png") no-repeat left top;
        background-size: 37%;
    }
    .payBox .pay-info .pay-title{
        height: 100%;
        width: auto;
        color: #989898;
        font-size: 16px;
        margin-left: 5%;
    }
    .payBox .pay-info .pay-num{
        height: 100%;
        width: auto;
        color: #EC164C;
        font-size: 16px;
    }
    .payBox .pay-btn{
        width: 100%;
        height: 2.4rem;
        font-size: .5rem;
    }
    .payBox .pay-btn .confirmPay{
        display: inline-block;
        text-align: center;
        width: 40%;
        height: 50%;
        margin: 1% 4%;
        background-color: #4279E6;
        color: #FFFFFF;
        border-radius: 4px;
        border: 2px solid #4279E6;
    }
    .confirmWaited{
        background-color: #D5D5D5!important;
        border: 2px solid#D5D5D5!important;
    }
    .payBox .pay-btn .cancelPay{
        display: inline-block;
        width: 40%;
        text-align: center;
        height: 50%;
        background-color: #FFFFFF;
        color: #D5D5D5;
        border-radius: 4px;
        border: 2px solid #D5D5D5;
        margin: 1% 4% 1% 8%;
    }
    .item .tip{
        color:#E86287!important;
    }
    .datePanel{
        width: 100%;
        height: 1rem;
        line-height: 1rem;
        text-align: center;
        letter-spacing: .05rem;
        background-color: rgb(233, 238, 241);
        font-size: .5rem;
        z-index: 999;
        position: fixed;
        top:0;
        color: #4088F4;
    }
    .scheduleList{
        width: 100%;
        line-height: 1rem;
        height: auto;
        display: none;
        padding: 0.5rem 0;
    }
    .scheduleList li{
        height: 1rem;
        line-height: 1rem;
        width: 44%;
        border-radius: 1rem;
        margin: 0.2rem 2%;
        display: inline-block;
        font-size: .45rem;
        text-align: center;
    }
    .scheduleList .schedule{
        border: 0.03rem solid #6B77F7;
        color: #444444;
    }
    .scheduleList .schedule-not{
        color: #999999;
        border: 0.03rem solid #CCCCCC;
        background-color: #CCCCCC;
    }
    .scheduleList .schedule-timeout{
        color: #cc7862;
        border: 0.03rem solid #cc7862;
        background-color: #FFFFff;
    }
    .scheduleList .noSchedule{
        height: 2rem;
        line-height: 2rem;
        width: 96%;
        border: 0.05rem solid #6B77F7;
        border-radius: 1rem;
        margin: 0.2rem 2%;
        display: inline-block;
        font-size: .8rem;
        color: #444444;
        text-align: center;
    }
    .layui-layer-title{
        padding: 0 2.7rem 0 .7rem!important;
        height: 1rem!important;
        line-height: 1rem!important;
        border-bottom: 0.08rem dotted #eee!important;
        font-size: .4rem!important;
        color: #333!important;
        overflow: hidden!important;
        background-color: #F8F8F8!important;
        border-radius: 0.1rem 0.1rem 0 0!important;
    }
    .float-menu {  width: 1.3rem;  height: 1.3rem;  position: fixed;  z-index: 999;  right: .1rem;  top: 2rem;border-radius: 50%;}
    .float-menu div{-webkit-transition:all 0.2s linear;-ms-transition:all 0.2s linear;-moz-transition:all 0.2s linear;transition:all 0.2s linear;}
    .float-menu .plus{width: 100%;height: 100%;background: url(" lp/static/images/bus/float_menu/menu-icon.png") no-repeat center center;background-size: 100%;z-index: 2;position: absolute;left: 0;top: 0;}
    .float-menu .plus .cross{width: 100%;height: 100%;position: absolute;left: 0;top: 0;z-index: 3;content: "";background:url(" lp/static/images/bus/float_menu/menu-add.png") no-repeat center center;background-size: 37%;}
    .float-menu .menu-list{opacity:0;width: 100%;height: 100%;z-index: 1;position: absolute;left: 0;top: 0;border-radius: 50%;}
    .float-menu .menu-list a{width: 33%;height: 16%;position: absolute;text-align: center;padding-top: 17%;opacity: 0;font-size: 0;color: #333;font-size: 12px;text-decoration: none;}
    .float-menu .menu-list a.link-schedule{left: 50%;top: 0;-webkit-transform:translate(-50%,0);-moz-transform:translate(-50%,0);-ms-transform:translate(-50%,0);transform:translate(-50%,0);background: url(" lp/static/images/bus/float_menu/icon-schedule.png") no-repeat center 5px;background-size: 50%;}
    .float-menu .menu-list a.link-login{left: 0%;top: 50%;-webkit-transform:translate(0%,-50%);-moz-transform:translate(0%,-50%);-ms-transform:translate(0%,-50%);transform:translate(0%,-50%);background: url(" lp/static/images/bus/float_menu/icon-people.png") no-repeat center top;background-size: 50%;}
    .float-menu .menu-list a.link-refresh{left: 50%;bottom: 0;-webkit-transform:translate(-50%,0);-moz-transform:translate(-50%,0);-ms-transform:translate(-50%,0);transform:translate(-50%,0);background: url(" lp/static/images/bus/float_menu/icon-refresh.png") no-repeat center top;background-size: 50%;}
    .float-menu.open .menu-list a{opacity: 1;font-size: .4rem;}
    .float-menu.open .cross{-webkit-transform:rotate(135deg);-moz-transform:rotate(135deg);-ms-transform:rotate(135deg);transform:rotate(135deg);border-radius: 100%;}
    .float-menu.open .menu-list{opacity: 1;width:300%;height: 300%;left: -100%;top: -100%;background-color: rgba(92,150,234,.7);}
    .float-menu .link-refresh .float-tips {  background-color: #f97157;  border-radius: 100%;  display: block;  position: absolute;  right: 0.01rem;  top: -0.05rem;  color: #fff;  min-width: .6rem;  min-height: .6rem;  line-height: .6rem;  text-align: center; }
    .hide{display: none;}
    .show{display: block}
    .rule{
        width: 1.3rem;
        height:1.3rem;
        line-height: 1.3rem;
        text-align: center;
        position: fixed;
        z-index: 50;
        right: .1rem;
        top: 4.6rem;
        background: url(" lp/static/images/bus/help-icon.png") no-repeat;
        background-size: contain;
    }
    .rule .rule-icon{
        width: 100%;
        height: 100%;
        background:url(" lp/static/images/bus/help.png") no-repeat center center;
        background-size: 70%;
    }
    .rule-content{
        width: 90%;
        height: auto;
        margin: .3rem auto;
        font-size: .45rem;
        color: #000000;
    }
    .rule-content p{
        line-height: .65rem;
    }
    .wait{
        background-color: #FFB800;
        border: 0.05rem solid #FFB800;
    }
</style>
#end
#define main()
<div class="datePanel">
    #(busInfo.aca051) #(week)
</div>
<div class="layui-container bg">
    <div class="layui-row navi">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item">
            <label>车牌号：</label>
            <span>#(busInfo.aaa002)</span>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item">
            <label>座位数：</label>
            <span>#(busInfo.aba003)座</span>
        </div>
        <!-- <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item">
             <label>座位号：</label>
             <span class="tip">暂未选座</span>
         </div>-->
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item">
            <label>驾驶员：</label>
            <span>#(busInfo.driver)</span>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item chooseSchedule">
            <label>时间：</label>
            <span id="aba050">#(busInfo.aba051)发车</span>
        </div>
        <div class="layui-col-xs12 layui-col-sm12 layui-col-md12 item">
            <label>类型：</label>
            <span style="color: red;">
                #if(busInfo.aca052==1)
                学生班车
                #end

                #if(busInfo.aca053==1)
                教工班车
                #end
            </span>
        </div>
        <div class="layui-col-xs12 layui-col-sm12 layui-col-md12 item">
            <label>路&nbsp;线：</label>
            <span style="font-size:0.4rem;">#(busInfo.aba007) ======#(busInfo.aba008)</span>
        </div>
        #if(busInfo.stop)
        <div class="layui-col-xs12 layui-col-sm12 layui-col-md12 item">
            <label>经停：</label>
            <span class="tip-info">#(busInfo.stop)</span>
        </div>
        #end
    </div>

    <div class="layui-row content">
        <div class="icon-title">
            <p>
                <img class="icon-seat" src="lp/static/images/bus/icon-seat-gray.png">
                <span>空位</span>
            </p>
            <p>
                <img class="icon-seat" src="lp/static/images/bus/icon-seat-red.png">
                <span>不可选</span>
            </p>
            <p>
                <img class="icon-seat" src="lp/static/images/bus/icon-seat-cyan.png">
                <span>已选</span>
            </p>
            <p>
                <img class="icon-seat" src="lp/static/images/bus/icon-seat-blue.png">
                <span>当前选择</span>
            </p>
        </div>
        <div class="bus45">
            <div class="driveZone">

            </div>
            <div class="seatContainer">

            </div>
        </div>
        <div class="btn-container">
            <button class="btn confirm">请先选择座位</button>
            <button class="btn cancel">取消选座</button>
        </div>
    </div>
    <div class="float-menu">
        <div class="plus"><div class="cross"></div></div>
        <div class="menu-list">
            <a href="javascript:showScheduleList();" class="link-schedule">班次表</a>
            <a href="javascript:toLogin();" class="link-login">#(ca04.aca040==null?"登录":ca04.aca043)</a>
            <a href="javascript:refresh();" class="link-refresh">刷新</a>
        </div>
    </div>
    <div class="rule"><div class="rule-icon"></div></div>
    <ul class="scheduleList" id="scheduleList">

    </ul>
</div>
<script type="text/javascript" src="lp/static/js/bus/auto_size.js"></script>
<script type="text/javascript" src="lp/static/js/bus/jquery-1.10.2/jquery.js"></script>
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>
<script type="text/javascript">
    let aca050='#(busInfo.aca050)',basePath=' ',max_count='#(max_count)';
    let layer;
    let payFlag=#(price>0);
    layui.use('layer',function(){
        layer=layui.layer;
        //加载车辆座位信息
        generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
        /*注册菜单按钮*/
        registerMenu();
        /*绑定规则按钮事件*/
        bindRuleClick();
        /*绑定取消选座事件*/
        bindCancelSeat();
        /*绑定其他事件*/
        bindOthers();
    });
    /*绑定其他事件*/
    function bindOthers(){
        $(".seatChoose").bind("click",function(){
            $(this).removeClass("seatChoose");
        });
        $(".confirm").bind("click",function(){
            //排队等待
            if($(this).hasClass("wait")){
                //wait();
            }else{
                buyTicket();
            }
        });
        $(window).resize(function() {
            window.location.reload();
        });
    }
    /*取消选座*/
    function bindCancelSeat(){
        $(".cancel").bind('click',function(){
            if($(".seatSelected").length>0){
                var seat=$(".seatSelected");
                var seatHtml="<div class='seatList'>";
                $.each(seat,function(i,val){
                    seatHtml+= "<button>"+$(val).html().trim()+"</button>";
                });
                seatHtml+="</div>";
                var cancelIndex=layer.open({
                    type:1
                    ,title:"选择需要取消的座位"
                    ,area:['100%','5rem']
                    ,offset: 'b'
                    ,content:
                        "<div class='payBox'>" +
                        "<div class='pay-info'>" +
                        seatHtml+
                        "</div>" +
                        "<div class='pay-btn'>" +
                        "<button class='confirmPay cancelSeat'>确定</button>" +
                        "<button class='cancelPay'>关闭</button>" +
                        "</div>" +
                        "</div>"
                    ,shadeClose:true
                    ,end:function(){
                        generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
                    }
                });
                $(".seatList button").on('click',function(){
                    $(this).toggleClass("choose-cancel");
                });
                $(".seatList").css("line-height",$(".seatList").height()+"px");
                $(".cancelSeat").unbind();
                $(".cancelSeat").bind('click',function(){
                    var seatNum="";
                    $.each($(".choose-cancel"),function(i,val){
                        seatNum+=$(val).html().trim()+","
                    });
                    if(seatNum==""){
                        layer.msg("请选择要取消的座位！",{icon:0});
                    }else{
                        var loadIndex=layer.load(2, {shade:.5});
                        $.ajax({
                            url:" bus/cancelChooseSeat"
                            ,type:"post"
                            ,data:{"aba041":seatNum,"aca050":'#(busInfo.aca050)',"aca031":"#(ca04.aca041)"}
                            ,success:function(data){
                                layer.close(loadIndex);
                                layer.close(cancelIndex);
                                if(data.flag==true){
                                    layer.msg(data.msg,{icon:6});
                                }else{
                                    layer.msg(data.msg,{icon:5});
                                }
                            }
                            ,error:function(){
                                layer.close(loadIndex);
                                layer.msg("服务器错误，稍后再试！");
                            }
                        });
                    }
                });
            }else{
                layer.msg("当前还未选择座位！",{icon:0});
            }

        });
    }
    //注册右上角菜单事件
    function registerMenu(){
        if(document.querySelector(".float-menu")){
            let plus = document.querySelector(".plus");
            let floatMenu = document.querySelector(".float-menu");
            $(".float-menu .menu-list a").removeClass("show").addClass("hide");
            plus.addEventListener("click", function(){
                if(floatMenu.className.indexOf("open") > -1){
                    floatMenu.className = "float-menu";
                    $(".float-menu .menu-list a").removeClass("show").addClass("hide");
                }else{
                    floatMenu.className = "float-menu open";
                    $(".float-menu .menu-list a").removeClass("hide").addClass("show");
                }
            },false);
        }
    }

    //绑定规则点击事件
    function bindRuleClick(){
        $(".rule").on('click',function(){
            layer.open({
                type:1
                ,content:"<div class='rule-content'>" +
                    "<p>1.每人最多预约"+max_count+"个座位</p>" +
                    "<p>2.不晚于开车时间可以预约座位</p>" +
                    "<p>3.不晚于开车时间可以申请退票</p>" +
                    "<p>4.在同一路线同一时刻下的班车，尽量选择排列靠前的班车</p>" +
                    /*"<p>4.若当前车次无空座可选，可点击【排队等待】按钮排队，超过学生班车座位数50%，调度室将酌情增派车辆</p>"+*/
                    "</div>"
                ,title:'规则说明'
                ,area:'80%'
                ,offset:'auto'
                ,shadeClose:true
                ,closeBtn:2
            });
        });
    }
    /*购票*/
    function buyTicket(){
        if(!isNotEmpty('#(ca04.aca040)')){
            alertMsg("该人员绑定信息已失效...",'warn')
            return false;
        }
        //购票
        var $seatChose=$(".seatChoose");
        var seatNumber="";
        $.each($seatChose,function(i,val){
            seatNumber+=$(val).html().trim()+",";
        });
        var seatLength=$seatChose.length;
        if(isNotEmpty($seatChose) && seatLength>0){
            if(seatLength>=1){
                var content="";
                var area=[];
                if(payFlag){
                    content=
                        "<div class='payBox'>"+
                        "<div class='pay-info'>"+
                        "<label class='pay-title'>订单金额：</label><span class='pay-num'>￥"+(parseInt('#(price)')/100)*seatLength+"元</span>"+
                        "</div>"+
                        "<div class='pay-btn'>" +
                        "<button class='confirmPay'>支付订单</button>"+
                        "<button class='cancelPay'>取消</button>"+
                        "</div>"+
                        "</div>";
                    area=['100%','5.4rem'];
                }else{
                    content=
                        "<div class='payBox'>"+
                        "<div class='pay-btn'>" +
                        "<button class='confirmPay'>确定</button>"+
                        "<button class='cancelPay'>取消</button>"+
                        "</div>"+
                        "</div>";
                    area=['100%','3.4rem'];
                }
                var payIndex=layer.open({
                    type:1
                    ,title:"选座确认"
                    ,area:area
                    ,offset: 'b'
                    ,content: content
                    ,shadeClose:true
                    ,end:function(){
                        generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
                    }
                });
                $(".pay-info").css("line-height",$(".pay-info").height()+"px");
                $(".pay-btn").css("line-height",$(".pay-btn").height()+"px");
                $(".confirmPay").bind('click',function(){
                    var loadIndex=layer.load(2, {shade:.5});
                    $.ajax({
                        url:" bus/chooseSeat"
                        ,type:"post"
                        ,data:{
                            "aba032":"#(busInfo.aca051)"
                            ,"aba041":seatNumber
                            ,"aca050":"#(busInfo.aca050)"
                            ,"type":"#(ca04.aca044)"
                            ,"aca040":"#(ca04.aca040)"
                        }
                        ,success:function(data){
                            layer.close(loadIndex);
                            if(data.flag==true){
                                var price='#(price)';
                                if(payFlag){//付款
                                    wx.miniProgram.navigateTo({
                                        url: '/pages/pay/index?total_fee='+(data.totalPrice)+"&chooseId="+(data.chooseId)
                                    });
                                }else{//其他不需要付款的跳转到车票页面
                                    wx.miniProgram.navigateTo({
                                        url: '/pages/bus/ticket/index'
                                    });
                                }
                            }else{
                                if(isNotEmpty(data.redirect_url)){
                                    //跳转到该车
                                    layer.msg(data.msg,{icon:5});
                                    setTimeout(function () {
                                        window.location.href=data.redirect_url;
                                    },5000)
                                }else{
                                    layer.msg(data.msg,{icon:5});
                                }
                            }
                            layer.close(payIndex);
                        }
                        ,error:function(res){
                            layer.close(loadIndex);
                            layer.close(payIndex);
                            layer.msg("服务器繁忙，稍后再试！",{icon:2});
                        }
                    });
                });
                $(".cancelPay").bind('click',function(){
                    layer.close(payIndex);
                });
            }else{

            }
        }else{
            layer.msg("请先选择座位后再提交哦！",{icon:0});
        }
    }
    /*刷新*/
    function refresh(){
        generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
        //window.location.href='bus/toBusDetail?aca050=#(busInfo.aca050)&openid=#(ca04.aca042)&random='+new Date().getTime();
    }

    /*跳往登录*/
    function toLogin(){
        if(!isNotEmpty("#(ca04.aca040)")){
            wx.miniProgram.navigateTo({
                url: '/pages/bus/bind-account/index'
            });
        }
    }
    /*生成座位信息*/
    function generateSeat(col,row,aca050){
        var width=$(".seatContainer").width();
        var height=$(".seatContainer").height();
        var seatWidth=width/(parseFloat(col)+0.1)+"px";
        var seatHeight=height/row+"px";
        var seatNum=0;
        $(".seatContainer").empty();
        for(var i=0;i<row;i++){
            for(var j=0;j<col;j++){
                $(".seatContainer").append("<div class='seatHidden' style='width: "+seatWidth+";height:"+seatHeight+";'  ordernum="+(++seatNum)+">0</div>");
            }
        }
        $(".seatContainer").css("line-height",seatHeight);
        generateSeatByAjax(seatHeight,'#(busInfo.aba020)',aca050);
    }
    function generateSeatByAjax(seatHeight,aba020,aca050){
        let loadIndex=layer.load(2,{shade:.5});
        $.ajax({
            url:' bus/getSeatInfo'
            ,type:'post'
            ,data:{"id":aba020,"aca050":aca050}
            ,success:function(res){
                if(isNotEmpty(res) && res.length!=0){
                    var $seat;
                    $.each(res,function(i,seat){
                        $seat=$(".seatContainer").find(".seatHidden[ordernum="+seat.aba045+"]");
                        if(isNotEmpty($seat)){
                            if(seat.isLocked==0){
                                $seat.removeClass('seatHidden').addClass('seat').html(seat.aba041).attr("id",seat.aba040).css("line-height",seatHeight);
                            }else{
                                if(seat.creator=='#(ca04.aca041)'){//当前登录人选择的车票
                                    $seat.removeClass('seatHidden').addClass('seatSelected').html(seat.aba041).attr("id",seat.aba040).attr("aca030",seat.aca030).css("line-height",seatHeight);
                                }else{//其他人选择的车票
                                    $seat.removeClass('seatHidden').addClass('seatLocked').html(seat.aba041).attr("id",seat.aba040).attr("aca030",seat.aca030).css("line-height",seatHeight);
                                }
                            }
                        }
                    });
                    bindClick();
                    if($(".seat").length==0){//表示无空位可选
                        $(".confirm").addClass("wait").html("预约已满...");
                    }else{
                        $(".confirm").removeClass("wait").html("请先选择座位");
                    }
                    if('#(busInfo.aaa995)' == 2){
                        $(".bus45").removeClass("bus45").addClass("bus44");
                    } else if('#(busInfo.aaa995)' == 1) {
                        $(".bus44").removeClass("bus44").addClass("bus45");
                    }
                }else{
                    layer.msg("服务器繁忙，加载座位图出错，稍后再试！",{icon:2});
                }
                layer.close(loadIndex);
            }
            ,error:function(res){
                layer.close(loadIndex);
                layer.msg("服务器繁忙，稍后再试！",{icon:2});
            }
        });
    }
    /*跳往调度列表*/
    function showScheduleList(){
        wx.miniProgram.navigateTo({
            url: '/pages/bus/index'
        });
    }
    /*座位点击事件*/
    function bindClick(){
        //最大可选择座位数
        let maxChooseNum=max_count;
        $(".seatContainer div").click(function(){
            var $this=$(this);
            if($this.hasClass("seatChoose")){

            }
            if($this.hasClass("seat")){
                var selected=$(".seatSelected").length;
                var number=maxChooseNum-parseInt(selected);
                if(selected>=maxChooseNum){
                    layer.msg("最多选择"+maxChooseNum+"个座位！");
                    $(".confirm").html("选座已满"+maxChooseNum+"个");
                }else{
                    if($(".seatChoose").length>=number){//不可选择
                        if($this.hasClass("seatChoose")){
                            $this.removeClass("seatChoose");
                        }else{
                            layer.msg("最多选择"+maxChooseNum+"个座位！");
                        }
                    }else{
                        $this.toggleClass("seatChoose");
                    }
                }
                $(".confirm").html("确认选座");
            }
            if($this.hasClass("seatLocked") && #(ca04.aca041=='3203444')){
                query($this.attr('aca030'));
                // window.location.href='bus/busTicket?aca030='+$this.attr('aca030')+'&random='+new Date().getTime();
            }
            //跳往个人车票
            if($this.hasClass("seatSelected")){
                /*alertMsg("可以在'我的车票'中点击车票直接查看车票详情","warn");*/
                layer.alert("可以在'我的车票'中点击车票直接查看车票详情",function(index){
                    window.location.href='bus/busTicket?aca030='+$this.attr('aca030')+'&random='+new Date().getTime();
                });
            }
        });
    }
    //排队等待
    function wait(){
        var waitIndex=layer.open({
            type:1
            ,title:"排队等待"
            ,area:['100%','30%']
            ,offset: 'b'
            ,content:
                "<div class='payBox'>" +
                "<div class='pay-info'>" +
                "<img class='icon reduce' src=' lp/static/images/bus/reduce.png'/>" +
                "<button class='people-num'>1</button>" +
                "<img class='icon add' src=' lp/static/images/bus/add.png'/>"+
                "</div>"+
                "<div class='pay-btn'>" +
                "<button class='confirmPay' id='confirmWait'>提交</button>"+
                "<button class='cancelPay' id='confirmClose'>关闭</button>"+
                "</div>"+
                "</div>"
            ,shadeClose:true
            ,end:function(){
                generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
            }
        });
        $(".reduce").on("click",function(){
            var num=parseInt($(".people-num").html().trim());
            if(num>1){
                $(".people-num").html(--num);
            }
        });
        $(".add").on("click",function(){
            var num=parseInt($(".people-num").html().trim());
            if(num<2){
                $(".people-num").html(++num);
            }
        });
        $("#confirmClose").on('click',function(){
            layer.close(waitIndex);
        });
        $("#confirmWait").on('click',function(){
            if(!$(this).hasClass("confirmWaited")){
                var index = layer.load(2);
                $.ajax({
                    url:"bus/waitInLine"
                    ,type:"post"
                    ,data:{"aba050":"#(busInfo.aba005)","aba081":$(".people-num").html().trim(),"aaa997":"1","aaa996":'1'}
                    ,success:function(res){
                        layer.close(index);
                        if(isNotEmpty(res)){
                            if(res.flag==true){
                                $("#confirmWait").addClass("confirmWaited").html("已提交");
                            }else{
                                $("#confirmWait").html("已提交");
                            }
                        }
                    }
                    ,error:function(res){

                    }
                });
            }
        });
    }
    function query(aca030){
        var layerIndex=layer.load(2,{shade:.6});
        $.ajax({
            type:'post'
            ,url:'bus/getInfoByAca030'
            ,data:{"aca030":aca030}
            ,success:function(res){
                layer.close(layerIndex);
                if(res.flag==true){
                    addOpacity(res.ca03);
                }else{
                    generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
                    layer.msg(res.msg);
                }
            }
            ,error:function(res){
                layer.msg(res.msg);
            }
        });
    }
    function addOpacity(ca03){
        var title="";
        if(ca03.aca044==1){
            title="学号";
        }else if(ca03.aca044==2){
            title="学号";
        }else if(ca03.aca044==3){
            title="工号";
        }else if(ca03.aca044==4){
            title="手机号";
        }
        var opacity="<div class='opacity'>" +
            "<div class='infoContent'>" +
            "<p class='title'>乘客信息</p>" +
            "<p class='info'><span class='info-n'>姓名</span><span class='info-v'>"+ca03.aca043+"</span></p>" +
            "<p class='info'><span class='info-n'>座位号</span><span class='info-v imp'>"+ca03.aba041+"</span></p>" +
            "<p class='info'><span class='info-n'>人员类型</span><span class='info-v'>"+ca03.aca044_dsc+"</span></p>" +
            "<p class='info'><span class='info-n'>"+title+"</span><span class='info-v'>"+ca03.aca041+"</span></p>" +
            "<p class='info'></p>" +
            "<button class='btn-close'>关闭</button>" +
            "</div>" +
            "</div>";
        $("body").append(opacity);
        $(".btn-close").click(function(){
            generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
            $(".opacity").remove();
        });
    }
</script>
<style>
    .opacity{
        position: fixed;
        top: 0;
        bottom: 0;;
        width: 100%;
        height: 100%;
        background-color: rgba(55,55,55,.6);
    }
    .infoContent{
        background-color: #ffffff;
        width: 90%;
        height: auto;
        border-radius: .1rem;
        margin: 0 auto;
        margin-top: 40%;
    }
    .title{
        background-color: #17B197;
        text-align: center;
        height: 1.6rem;
        border-radius: .1rem .1rem 0 0;
        color: #fff;
        line-height: 1.6rem;
        font-size: .7rem;
    }
    .info span{
        font-size: .5rem;
        height: 1rem;
        line-height: 1rem;
        margin: .2rem .5rem;
        display: inline-block;
    }
    .info-n{
        color: #9A9A9A;
        width: 2.4rem;
        text-align: justify;
        float: left;
    }
    .info-n:after{
        display: inline-block;
        content: "";
        width: 100%;
    }
    .info-v{
        color: #333;
    }
    .btn-close{
        width: 96%;
        margin: .6rem 2%;
        height: 1.3rem;
        line-height: 1.3rem;
        text-align: center;
        background-color: #17B197;
        color: #ffffff;
        border: .05rem solid #17B197;
        border-radius: .1rem;
        font-size: .6rem;
    }
    .imp{
        color: #ff2222;
    }
</style>
#end