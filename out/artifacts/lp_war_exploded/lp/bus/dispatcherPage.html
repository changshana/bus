#@busCommon()
#define css()
<style type="text/css">
    .bg{
        background:url(" lp/static/images/bus/bus_phone_bg.jpg") no-repeat center;
        background-size: 100% 100%;
        overflow-x: hidden;
        overflow-y: auto;
        width: 100%;
        height: auto;
        margin: 0 auto;
        padding-top: 1rem;
    }
    .navi{
        height:20% ;
        width: 100%;
        background-color: transparent;
        margin: 0 auto;
        border-bottom:0.03rem solid #DBDCDB;
    }
    .content{
        height: 80%;
        width: 100%;
        background-color: transparent;
        margin: 0 auto;
    }
    .item{
        height: 1rem;
        line-height: 1rem;
        font-size: 0.45rem;
    }
    .item label{
        color: #999999;
    }
    .item span{
        color: #444444;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }
    .icon-title{
        width: 8.5rem;
        height: auto;
        margin: 0.3rem auto;
        font-size: 0.4rem;
        text-align: justify;
    }
    .icon-title p {
        width: 2rem;
        height: 1rem;
        display: inline-block;
        text-align: center;
    }
    .icon-title p img{
        display: inline-block;
        height: 1rem;
    }
    .icon-title p span{
        display: block;
        width: auto;
        height: .8rem;
        line-height: .8rem;
    }
    .bus45{
        background:url(" lp/static/images/bus/bus_planform_bg_45.png") no-repeat center center;
        background-size: contain;
        width: 10rem;
        height: 16rem;
        margin: 0 auto;
    }
    .bus44{
        background:url(" lp/static/images/bus/bus_planform_bg_44.png") no-repeat center center;
        background-size: contain;
        width: 10rem;
        height: 16rem;
        margin: 0 auto;
    }
    .btn-container{
        width: 8.5rem;
        height: auto;
        margin: 0.15rem auto;
        font-size: .5rem;
    }
    .btn{
        display: inline-block;
        margin: 0.1rem auto;
        width: 100%;
        height: 1.3rem;
        border-radius: 0.13rem;
        border: 0.05rem solid #6B77F7;
        font-weight: bold;
    }
    .confirm{
        color: #FFFFFF;
        background-color: #6B77F7;
    }
    .cancel{
        color: #6B77F7;
        background-color: #FFFFFF;
    }
    .driveZone {
        width: 8.5rem;
        height: .8rem;
        margin: 0 auto;
    }
    .seatContainer{
        width: 8.5rem;
        height: 14.8rem;
        margin: 0 auto;
        font-size: .3rem;
    }
    .seat{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-gray.png") no-repeat center center;
        background-size: contain;
        text-align: center;
        vertical-align: bottom;
        color: #666666;
    }
    .seatHidden{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-gray.png") no-repeat center center;
        background-size: contain;
        text-align: center;
        visibility: hidden;
    }
    .seatChoose{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-blue.png") no-repeat center center;
        background-size: contain;
        text-align: center;
    }
    .seatSelected{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-cyan.png") no-repeat center center;
        background-size: contain;
        text-align: center;
    }
    .seatLocked{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-red.png") no-repeat center center;
        background-size: contain;
        text-align: center;
    }
    .seatNum{
        color: #6c6c6c;
    }
    .payBox {
        width: 100%;
        height: 100%;
    }
    .payBox .pay-info{
        height: 2rem;
        width: 100%;
    }
    .payBox .pay-info .icon{
        height: 35%;
        float: left;
    }
    .payBox .pay-info .reduce{
        margin: 8% 2% 0 5%;
    }
    .payBox .pay-info .add{
        margin: 8% 2% 0 2%;
    }
    .payBox .pay-info .people-num{
        height: 35%;
        width: 30%;
        border: .02rem solid #D4D4D4;
        margin: 8% 2% 0 2%;
        display: inline-block;
        font-size: .5rem;
    }
    .payBox .pay-info .seatList{
        width: 90%;
        height: 90%;
        margin: 0% 5%;
        float: left;
    }
    .payBox .pay-info button{
        width: 25%;
        height: 50%;
        float: left;
        margin: 8% 2%;
        font-size: .5rem;
        text-align: center;
        border:0.05rem solid #D4D4D4;
        background-color:#FFFFFF;
        color:#000;
        border-radius: .1rem;
    }
    .payBox .pay-info .choose-cancel{
        background: url(" lp/static/images/bus/ticket-cancel.png") no-repeat left top;
        background-size: 37%;
    }
    .payBox .pay-info .pay-title{
        height: 100%;
        width: auto;
        color: #989898;
        font-size: 16px;
        margin-left: 5%;
    }
    .payBox .pay-info .pay-num{
        height: 100%;
        width: auto;
        color: #EC164C;
        font-size: 16px;
    }
    .payBox .pay-btn{
        width: 100%;
        height: 2.4rem;
        font-size: .5rem;
    }
    .payBox .pay-btn .confirmPay{
        display: inline-block;
        text-align: center;
        width: 40%;
        height: 50%;
        margin: 1% 4%;
        background-color: #4279E6;
        color: #FFFFFF;
        border-radius: 4px;
        border: 2px solid #4279E6;
    }
    .confirmWaited{
        background-color: #D5D5D5!important;
        border: 2px solid#D5D5D5!important;
    }
    .payBox .pay-btn .cancelPay{
        display: inline-block;
        width: 40%;
        text-align: center;
        height: 50%;
        background-color: #FFFFFF;
        color: #D5D5D5;
        border-radius: 4px;
        border: 2px solid #D5D5D5;
        margin: 1% 4% 1% 8%;
    }
    .item .tip{
        color:#E86287!important;
    }
    .datePanel{
        width: 100%;
        height: 1rem;
        line-height: 1rem;
        text-align: center;
        letter-spacing: .05rem;
        background-color: rgb(233, 238, 241);
        font-size: .5rem;
        z-index: 999;
        position: fixed;
        top:0;
        color: #4088F4;
    }
    .layui-layer-title{
        padding: 0 2.7rem 0 .7rem!important;
        height: 1rem!important;
        line-height: 1rem!important;
        border-bottom: 0.08rem dotted #eee!important;
        font-size: .4rem!important;
        color: #333!important;
        overflow: hidden!important;
        background-color: #F8F8F8!important;
        border-radius: 0.1rem 0.1rem 0 0!important;
    }
    .full{
        background-color: #FFB800;
        border: 0.05rem solid #FFB800;
    }
</style>
#end
#define main()
<div class="datePanel">
    #(busInfo.aca051) #(week)
</div>
<div class="layui-container bg">
    <div class="layui-row navi">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item">
            <label>车牌号：</label>
            <span>#(busInfo.aaa002)</span>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item">
            <label>座位数：</label>
            <span>#(busInfo.aba003)座</span>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item">
            <label>驾驶员：</label>
            <span>#(busInfo.driver)</span>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item chooseSchedule">
            <label>时间：</label>
            <span id="aba050">#(busInfo.aba051)发车</span>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item">
            <label>类型：</label>
            <span style="color: red;">
                #if(busInfo.aca052==1)
                学生班车
                #end

                #if(busInfo.aca053==1)
                教工班车
                #end
            </span>
        </div>
        <div class="layui-col-xs12 layui-col-sm12 layui-col-md12 item">
            <label>路线：</label>
            <span>#(busInfo.aba007) === #(busInfo.aba008)</span>
        </div>
        #if(busInfo.stop)
        <div class="layui-col-xs12 layui-col-sm12 layui-col-md12 item">
            <label>经停：</label>
            <span style="font-size:0.4rem;color: red;">#(busInfo.stop)</span>
        </div>
        #end
    </div>

    <div class="layui-row content">
        <div class="icon-title">
            <p>
                <img class="icon-seat" src="lp/static/images/bus/icon-seat-gray.png">
                <span>空位</span>
            </p>
            <p>
                <img class="icon-seat" src="lp/static/images/bus/icon-seat-red.png">
                <span>不可选</span>
            </p>
            <p>
                <img class="icon-seat" src="lp/static/images/bus/icon-seat-cyan.png">
                <span>已锁定</span>
            </p>
            <p>
                <img class="icon-seat" src="lp/static/images/bus/icon-seat-blue.png">
                <span>当前选择</span>
            </p>
        </div>
        <div class="bus45">
            <div class="driveZone">

            </div>
            <div class="seatContainer">

            </div>
        </div>
        <div class="btn-container">
            <button class="btn confirm">锁定座位</button>
            <button class="btn cancel">取消发车</button>
        </div>
    </div>
</div>
<script type="text/javascript" src="lp/static/js/bus/auto_size.js"></script>
<script type="text/javascript" src="lp/static/js/bus/jquery-1.10.2/jquery.js"></script>
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>
<script type="text/javascript">
    var aca050='#(busInfo.aca050)',basePath=' ';
    layui.use('layer',function(){
        var $=layui.$,layer=layui.layer;
        generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
        $(".seatChoose").bind("click",function(){
            $(this).removeClass("seatChoose");
        });

        $(".confirm").bind("click",function(){
            //锁定座位
            var $seatChose=$(".seatChoose");
            var seats = "";
            $.each($seatChose, function (i, value) {
                seats += $(value).html() + ",";
            });
            seats = seats.substr(0, seats.length - 1);
            if(isNotEmpty($seatChose) && seats.length>0){
                var confirmIndex = layer.confirm("确定锁定本车【" + seats + "】号座位？", function () {
                    layer.close(confirmIndex);
                    var loadIndex = layer.load(
                        2,
                        {
                            shade: 0.4,
                            content: "<p style='font-size: 24px;color:#F6F6F6; width: 180px;margin-left: 40px;'>请稍候...</p>"
                        }
                    );
                    $.ajax({
                        url: 'bus/chooseSeat',
                        data: {'aba032': '#(busInfo.aca051)', 'aca050': '#(busInfo.aca050)', 'aba041': seats,'type':0}
                        , success: function (data) {
                            layer.close(loadIndex);
                            if (data.flag == true) {
                                layer.msg(data.msg,{icon:6});
                            } else {
                                layer.msg(data.msg, {icon: 5});
                            }
                            generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
                        }
                        , error: function () {
                            alertMsg("服务器繁忙，稍后再试！", 'error');

                        }
                    });
                });
            }else{
                layer.msg("请先选择座位后再提交锁定哦！",{icon:0});
            }
        });
        /*取消选座*/
        $(".cancel").bind('click',function(){
            var index=layer.confirm('是否确认取消发车？', {icon: 3, title:'提示'}, function(index){
                layer.close(index);
                var loadIndex=layer.load(2,{'shade':0.5});
                $.ajax({
                    type:'post'
                    ,url:'bus/cancelBus'
                    ,data:{'aca050':'#(busInfo.aca050)'}
                    ,success:function(res){
                        layer.close(loadIndex);
                        layer.msg(res.msg);
                        setTimeout(function () {
                            //TODO 更换跳转地址
                            wx.miniProgram.redirectTo({
                                url: '/pages/bus/bus-dispatch/list'
                            });
                        },1000);
                    }
                    ,error:function(res){
                        generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
                        layer.msg("系统繁忙，稍后再试！")
                    }
                });
            });
        });
    });
    $(window).resize(function() {
        window.location.reload();
    });
    function generateSeat(col,row,aca050){
        var width=$(".seatContainer").width();
        var height=$(".seatContainer").height();
        var seatWidth=width/(parseFloat(col)+0.1)+"px";
        var seatHeight=height/row+"px";
        var seatNum=0;
        $(".seatContainer").empty();
        for(var i=0;i<row;i++){
            for(var j=0;j<col;j++){
                $(".seatContainer").append("<div class='seatHidden' style='width: "+seatWidth+";height:"+seatHeight+";'  ordernum="+(++seatNum)+">0</div>");
            }
        }
        $(".seatContainer").css("line-height",seatHeight);
        generateSeatByAjax(seatHeight,'#(busInfo.aba020)',aca050);
    }
    function generateSeatByAjax(seatHeight,aba020,aca050){
        $.ajax({
            url:' bus/getSeatInfo'
            ,type:'post'
            ,data:{"id":aba020,"aca050":aca050}
            ,success:function(res){
                if(isNotEmpty(res) && res.length!=0){
                    var $seat;
                    $.each(res,function(i,seat){
                        $seat=$(".seatContainer").find(".seatHidden[ordernum="+seat.aba045+"]");
                        if (isNotEmpty(seat)) {
                            if (seat.isLocked == 1 && seat.aca044 == 0) {//锁定座位
                                $seat.removeClass('seatHidden').addClass('seatSelected').html(seat.aba041).attr("id",seat.aba040).attr("aca030",seat.aca030).css("line-height",seatHeight);
                            } else if (seat.isLocked == 1) {//选择座位
                                $seat.removeClass('seatHidden').addClass('seatLocked').html(seat.aba041).attr("id",seat.aba040).attr("aca030",seat.aca030).css("line-height",seatHeight);
                            } else {//空位
                                $seat.removeClass('seatHidden').addClass('seat').html(seat.aba041).attr("id",seat.aba040).css("line-height",seatHeight);
                            }
                        }
                    });
                    bindClick();
                    if($(".seat").length==0){//表示无空位可选
                        $(".confirm").addClass("full").html("选座已满");
                    }else{
                        $(".confirm").removeClass("full").html("锁定座位");
                    }
                    if('#(busInfo.aaa995)' == 2){
                        $(".bus45").removeClass("bus45").addClass("bus44");
                    } else if('#(busInfo.aaa995)' == 1) {
                        $(".bus44").removeClass("bus44").addClass("bus45");
                    }
                }else{
                    layer.msg("服务器繁忙，加载座位图出错，稍后再试！",{icon:2});
                }
            }
            ,error:function(res){
                layer.msg("服务器繁忙，稍后再试！",{icon:2});
            }
        });
    }
    /*座位点击事件*/
    function bindClick(){
        $(".seatContainer div").click(function(){
            var $this=$(this);
            if($this.hasClass("seatSelected")){
                var aba041 = $this.html();
                var cancelIndex = layer.confirm("是否要解锁【" + aba041 + "】号座位？", function () {
                    $.ajax({
                        url: "bus/cancelChooseSeat"
                        , type: "post"
                        , data: {"aba041": aba041, "aca050": '#(busInfo.aca050)', "aba032": '#(busInfo.aca051)'}
                        , success: function (data) {
                            generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
                            layer.close(cancelIndex);
                        }
                        , error: function () {
                            layer.close(cancelIndex);
                            layer.msg("服务器错误，稍后再试！");
                            setTimeout(function () {
                                generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
                            },500)
                        }
                    });
                });
            }
            if($this.hasClass("seat")){
                $this.toggleClass("seatChoose");
                $(".confirm").html("锁定座位");
            }
            if($this.hasClass("seatLocked")){
                window.location.href='bus/busTicket?aca030='+$this.attr('aca030')+'&random='+new Date().getTime();
            }
        });
    }
</script>
#end