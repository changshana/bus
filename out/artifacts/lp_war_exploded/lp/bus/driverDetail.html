#@busCommon()
#define css()
<style type="text/css">
    .bg{
        background:url(" lp/static/images/bus/bus_phone_bg.jpg") no-repeat center;
        background-size: 100% 100%;
        overflow-x: hidden;
        overflow-y: auto;
        width: 100%;
        height: auto;
        margin: 0 auto;
        padding-top: 1rem;
    }
    .navi{
        height:20% ;
        width: 100%;
        background-color: transparent;
        margin: 0 auto;
        border-bottom:0.03rem solid #DBDCDB;
    }
    .content{
        height: 80%;
        width: 100%;
        background-color: transparent;
        margin: 0 auto;
        padding-bottom: 1rem;
    }
    .item{
        height: 1rem;
        line-height: 1rem;
        font-size: 0.45rem;
    }
    .item label{
        color: #999999;
    }
    .item span{
        color: #444444;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }
    .icon-title{
        width: 8.5rem;
        height: 1rem;
        line-height: 1rem;
        margin: 0.3rem auto;
        font-size: 0.4rem;
        text-align: justify;
    }
    .icon-title p {
        width: 2.8rem;
        height: 1rem;
        float: left;
        text-align: center;
    }
    .icon-title p img{
        height: 1rem;
        float: left;
    }
    .icon-title p span{
        margin-left: .2rem;
        width: auto;
        height: 1rem;
        line-height: 1.2rem;
        float: left;
    }
    .bus{
        width: 10rem;
        height: 16rem;
        margin: 0 auto;
    }
    .bus45{
        background:url(" lp/static/images/bus/bus_planform_bg_45.png") no-repeat center center;
        background-size: contain;
    }
    .bus44{
        background:url(" lp/static/images/bus/bus_planform_bg_44.png") no-repeat center center;
        background-size: contain;
    }
    .btn-container{
        width: 8.5rem;
        height: auto;
        margin: 0.15rem auto;
        font-size: .5rem;
    }
    .btn{
        display: inline-block;
        margin: 0.1rem auto;
        width: 100%;
        height: 1.3rem;
        border-radius: 0.13rem;
        border: 0.05rem solid #6B77F7;
        font-weight: bold;
    }
    .confirm{
        color: #FFFFFF;
        background-color: #6B77F7;
    }
    .cancel{
        color: #6B77F7;
        background-color: #FFFFFF;
    }
    .driveZone {
        width: 8.5rem;
        height: .8rem;
        margin: 0 auto;
    }
    .seatContainer{
        width: 8.5rem;
        height: 14.8rem;
        margin: 0 auto;
        font-size: .3rem;
    }
    .seat{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-gray.png") no-repeat center center;
        background-size: contain;
        text-align: center;
        vertical-align: bottom;
        color: #666666;
    }
    .seatHidden{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-gray.png") no-repeat center center;
        background-size: contain;
        text-align: center;
        visibility: hidden;
    }
    .seatChoose{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-blue.png") no-repeat center center;
        background-size: contain;
        text-align: center;
    }
    .seatSelected{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-cyan.png") no-repeat center center;
        background-size: contain;
        text-align: center;
    }
    .seatLocked{
        display: inline-block;
        background: url(" lp/static/images/bus/icon-seat-red.png") no-repeat center center;
        background-size: contain;
        text-align: center;
    }
    .seatNum{
        color: #6c6c6c;
    }
    .item .tip{
        color:#E86287!important;
    }
    .datePanel{
        width: 100%;
        height: 1rem;
        line-height: 1rem;
        text-align: center;
        letter-spacing: .1rem;
        background-color: rgb(233, 238, 241);
        font-size: .5rem;
        z-index: 999;
        position: fixed;
        top:0;
        color: #4088F4;
    }
    .float-menu {  width: 1.3rem;  height: 1.3rem;  position: fixed;  z-index: 999;  right: .1rem;  top: 2rem;border-radius: 50%;}
</style>
#end
#define main()
<div class="datePanel">
    #(busInfo.aca051) #(week)
</div>
<div class="layui-container bg">
    <div class="layui-row navi">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item">
            <label>车名：</label>
            <span>#(busInfo.aaa002)</span>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item">
            <label>类型：</label>
            <span>#(busInfo.aba003)座大巴</span>
        </div>
        <!--<div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item">
            <label>座位号：</label>
            <span class="tip">暂未选座</span>
        </div>-->
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item chooseSchedule">
            <label>发车时间：</label>
            <span id="aba050">#(busInfo.aba051)</span>
        </div>
        <div class="layui-col-xs12 layui-col-sm12 layui-col-md12 item">
            <label>类型：</label>
            <span style="color: red;">
                #if(busInfo.aca052==1)
                学生班车
                #end

                #if(busInfo.aca053==1)
                教工班车
                #end
            </span>
        </div>
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 item">
            <label>驾驶员：</label>
            <span>#(busInfo.driver)</span>
        </div>
        <div class="layui-col-xs12 layui-col-sm12 layui-col-md12 item">
            <label>车牌号：</label>
            <span>#(busInfo.aaa005)</span>
        </div>
        <div class="layui-col-xs12 layui-col-sm12 layui-col-md12 item">
            <label>路线：</label>
            <span>#(busInfo.aba007) == #(busInfo.aba008)</span>
        </div>
    </div>

    <div class="layui-row content">
        <div class="icon-title">
            <p>
                <img class="icon-seat" src="lp/static/images/bus/icon-seat-gray.png">
                <span>空位</span>
            </p>
            <p>
                <img class="icon-seat" src="lp/static/images/bus/icon-seat-red.png">
                <span>已选</span>
            </p>
            <p>
                <img class="icon-seat" src="lp/static/images/bus/icon-seat-cyan.png">
                <span>后台锁定</span>
            </p>
        </div>
        <div class="bus bus45">
            <div class="driveZone">

            </div>
            <div class="seatContainer">

            </div>
        </div>
        <!--<div class="btn-container">
            <button class="btn confirm">请先选择座位</button>
            <button class="btn cancel">取消选座</button>
        </div>-->
    </div>
</div>
<img class="float-menu" src="lp/static/images/bus/float_menu/scan.png"/>
<script type="text/javascript" src="lp/static/js/bus/auto_size.js"></script>
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>
<script type="text/javascript">
    var aca050='#(busInfo.aca050)',basePath=' ';
    layui.use('layer',function(){
        var $=layui.$,layer=layui.layer;
        $(window).resize(function() {
            window.location.reload();
        });
        generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
        setTimeout(function(){
            setInterval(function(){
                generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
            },60*1000);
        },2000);
        toScanQRCode();
    });
    function toScanQRCode(){
        $(".float-menu").click(function(){
            wx.miniProgram.navigateTo({
                url: '/pages/bus/scanQRCode/index?role=#(role)&busId=#(busInfo.aca050)'
            });
        });
    }
    function generateSeat(col,row,aca050){
        var width=$(".seatContainer").width();
        var height=$(".seatContainer").height();
        var seatWidth=width/(parseFloat(col)+0.1)+"px";
        var seatHeight=height/row+"px";
        var seatNum=0;
        $(".seatContainer").empty();
        for(var i=0;i<row;i++){
            for(var j=0;j<col;j++){
                $(".seatContainer").append("<div class='seatHidden' style='width: "+seatWidth+";height:"+seatHeight+";'  ordernum="+(++seatNum)+">0</div>");
            }
        }
        $(".seatContainer").css("line-height",seatHeight);
        generateSeatByAjax(seatHeight,'#(busInfo.aba020)',aca050);
    }
    function generateSeatByAjax(seatHeight,aba020,aca050){
        $.ajax({
            url:' bus/getSeatInfo'
            ,type:'post'
            ,data:{"id":aba020,"aca050":aca050}
            ,success:function(res){
                if(isNotEmpty(res) && res.length!=0){
                    var $seat;
                    $.each(res,function(i,seat){
                        $seat=$(".seatContainer").find(".seatHidden[ordernum="+seat.aba045+"]");
                        if(isNotEmpty($seat)){
                            if(seat.isLocked==0){
                                $seat.removeClass('seatHidden').addClass('seat').html(seat.aba041).attr("id",seat.aba040).css("line-height",seatHeight);
                            }else{
                                if(seat.aca044==0){
                                    $seat.removeClass('seatHidden').addClass('seatSelected').html(seat.aba041).attr("id",seat.aba040).attr("aca030",seat.aca030).css("line-height",seatHeight);
                                }else{
                                    $seat.removeClass('seatHidden').addClass('seatLocked').html(seat.aba041).attr("id",seat.aba040).attr("aca030",seat.aca030).css("line-height",seatHeight);
                                }
                            }
                        }
                    });
                    bindClick();
                    if($(".seat").length==0){//表示无空位可选
                        $(".confirm").addClass("wait").html("排队等待...");
                    }
                    if('#(busInfo.aaa995)' == 2){
                        $(".bus45").removeClass("bus45").addClass("bus44");
                    } else if('#(busInfo.aaa995)' == 1) {
                        $(".bus44").removeClass("bus44").addClass("bus45");
                    }
                }else{
                    layer.msg("服务器繁忙，加载座位图出错，稍后再试！",{icon:2});
                }
            }
            ,error:function(res){
                layer.msg("服务器繁忙，稍后再试！",{icon:2});
            }
        });
    }
    /*座位点击事件*/
    function bindClick(){
        $(".seatContainer div").click(function(){
            var $this=$(this);
            if($this.hasClass("seatLocked")){
                query($this.attr('aca030'));
            }
        });
    }
    function query(aca030){
        var layerIndex=layer.load(2,{shade:.6});
        $.ajax({
            type:'post'
            ,url:'bus/getInfoByAca030'
            ,data:{"aca030":aca030}
            ,success:function(res){
                layer.close(layerIndex);
                if(res.flag==true){
                    addOpacity(res.ca03);
                }else{
                    generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
                    layer.msg(res.msg);
                }
            }
            ,error:function(res){
                layer.msg(res.msg);
            }
        });
    }
    function addOpacity(ca03){
        var title="";
        if(ca03.aca044==1){
            title="学号";
        }else if(ca03.aca044==2){
            title="学号";
        }else if(ca03.aca044==3){
            title="工号";
        }else if(ca03.aca044==4){
            title="手机号";
        }
        var opacity="<div class='opacity'>" +
            "<div class='infoContent'>" +
            "<p class='title'>乘客信息</p>" +
            "<p class='info'><span class='info-n'>姓名</span><span class='info-v'>"+ca03.aca043+"</span></p>" +
            "<p class='info'><span class='info-n'>座位号</span><span class='info-v imp'>"+ca03.aba041+"</span></p>" +
            "<p class='info'><span class='info-n'>人员类型</span><span class='info-v'>"+ca03.aca044_dsc+"</span></p>" +
            "<p class='info'><span class='info-n'>"+title+"</span><span class='info-v'>"+ca03.aca041+"</span></p>" +
            "<p class='info'><span class='info-n'>支付状态</span><span class='info-v'>"+ca03.aca035+"</span></p>" +
            "<button class='btn-close'>关闭</button>" +
            "</div>" +
            "</div>";
        $("body").append(opacity);
        $(".btn-close").click(function(){
            generateSeat('#(busInfo.col)','#(busInfo.row)','#(busInfo.aca050)');
            $(".opacity").remove();
        });
    }
</script>
<style>
    .opacity{
        position: fixed;
        top: 0;
        bottom: 0;;
        width: 100%;
        height: 100%;
        background-color: rgba(55,55,55,.6);
    }
    .infoContent{
        background-color: #ffffff;
        width: 90%;
        height: auto;
        border-radius: .1rem;
        margin: 0 auto;
        margin-top: 40%;
    }
    .title{
        background-color: #17B197;
        text-align: center;
        height: 1.6rem;
        border-radius: .1rem .1rem 0 0;
        color: #fff;
        line-height: 1.6rem;
        font-size: .7rem;
    }
    .info span{
        font-size: .5rem;
        height: 1rem;
        line-height: 1rem;
        margin: .2rem .5rem;
        display: inline-block;
    }
    .info-n{
        color: #9A9A9A;
        width: 2.4rem;
        text-align: justify;
        float: left;
    }
    .info-n:after{
        display: inline-block;
        content: "";
        width: 100%;
    }
    .info-v{
        color: #333;
    }
    .btn-close{
        width: 96%;
        margin: .6rem 2%;
        height: 1.3rem;
        line-height: 1.3rem;
        text-align: center;
        background-color: #17B197;
        color: #ffffff;
        border: .05rem solid #17B197;
        border-radius: .1rem;
        font-size: .6rem;
    }
    .imp{
        color: #ff2222;
    }
</style>
#end